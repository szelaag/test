<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel admina — Limitless Web</title>
  <link rel="icon" href="/assets/logo.svg">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;background:#0b1221;color:#e6edf6;margin:0}
    header{position:sticky;top:0;background:#0f172a;border-bottom:1px solid #1f2a44;padding:12px 20px;display:flex;align-items:center;gap:12px;z-index:10}
    header h1{font-size:18px;margin:0}
    main{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:#0f172a;border:1px solid #1f2a44;border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,textarea{width:100%;background:#0b1221;border:1px solid #27324d;border-radius:10px;color:#e6edf6;padding:10px}
    label{font-size:12px;opacity:.8}
    button{background:#4f46e5;border:0;color:white;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.secondary{background:#1f2a44}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2a44;padding:8px 6px;text-align:left;font-size:14px}
    .right{margin-left:auto}
    .muted{opacity:.7}
    .danger{background:#b91c1c}
    .success{background:#16a34a}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <img src="/assets/logo.svg" alt="" height="24">
    <h1>Panel admina</h1>
    <span class="right"></span>
    <button id="logoutBtn" class="secondary">Wyloguj</button>
  </header>
  <main>
    <section id="login-card" class="card" style="display:none">
      <h2>Logowanie</h2>
      <div class="grid">
        <div>
          <label>Login</label>
          <input type="text" id="username" autocomplete="username" placeholder="admin">
        </div>
        <div>
          <label>Hasło</label>
          <input type="password" id="password" autocomplete="current-password" placeholder="••••••••">
        </div>
      </div>
      <p id="login-status" class="muted"></p>
      <button id="loginBtn">Zaloguj</button>
    </section>

    <section id="projects-card" class="card" style="display:none">
      <div style="display:flex;gap:12px;align-items:center">
        <h2 style="margin:0">Realizacje</h2>
        <button id="reloadBtn" class="secondary">Odśwież</button>
        <span class="right"></span>
        <button id="newBtn" class="success">+ Dodaj projekt</button>
      </div>
      <table id="projects-table">
        <thead>
          <tr><th>#</th><th>Tytuł</th><th>Obraz</th><th>Link</th><th>Kolejność</th><th>Akcje</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="edit-card" class="card" style="display:none">
      <h2 id="edit-title">Nowy projekt</h2>
      <div class="grid">
        <div><label>Tytuł</label><input id="p-title"></div>
        <div><label>Link (opcjonalnie)</label><input id="p-link"></div>
        <div class="row" style="grid-column:1/-1"><div style="flex:1"><label>Adres obrazka (URL)</label><input id="p-image"></div></div>
        <div style="grid-column:1/-1"><label>Opis</label><textarea id="p-desc" rows="5"></textarea></div>
        <div><label>Kolejność (0–n; mniejsze = wyżej)</label><input id="p-order" type="number" value="0"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="saveBtn" class="success">Zapisz</button>
        <button id="cancelBtn" class="secondary">Anuluj</button>
      </div>
    </section>
  </main>

  <script>
    const qs = sel => document.querySelector(sel);
    const tBody = qs('#projects-table tbody');
    let editingId = null;

    async function checkAuth(){
      const pr = await fetch('/api/admin/me', {method:'GET'});
      const authed = pr.ok;
      qs('#login-card').style.display = authed ? 'none' : 'block';
      qs('#projects-card').style.display = authed ? 'block' : 'none';
      qs('#edit-card').style.display = 'none';
      if(authed) loadList();
    }

    async function login(){
      const username = qs('#username').value.trim();
      const password = qs('#password').value;
      qs('#login-status').textContent = 'Logowanie...';
      const r = await fetch('/api/admin/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username, password})
      });
      if(r.ok){
        qs('#login-status').textContent = 'Zalogowano.';
        checkAuth();
      } else {
        qs('#login-status').textContent = 'Błędny login lub hasło.';
      }
    }

    async function logout(){
      await fetch('/api/admin/logout', {method:'POST'});
      location.reload();
    }

    async function loadList(){
      const r = await fetch('/api/projects');
      const data = await r.json();
      tBody.innerHTML='';
      (data.projects||[]).sort((a,b)=>(a.order_num??0)-(b.order_num??0)).forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td>\${p.id}</td>
          <td>\${p.title||''}</td>
          <td><div class="muted" style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">\${p.imageUrl||''}</div></td>
          <td><div class="muted" style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">\${p.linkUrl||''}</div></td>
          <td>\${p.order_num??0}</td>
          <td>
            <button data-id="\${p.id}" class="editBtn secondary">Edytuj</button>
            <button data-id="\${p.id}" class="delBtn danger">Usuń</button>
          </td>
        \`;
        tBody.appendChild(tr);
      });
    }

    function openEditor(p){
      editingId = p?.id ?? null;
      qs('#edit-title').textContent = editingId ? 'Edytuj projekt' : 'Nowy projekt';
      qs('#p-title').value = p?.title || '';
      qs('#p-link').value = p?.linkUrl || '';
      qs('#p-image').value = p?.imageUrl || '';
      qs('#p-desc').value = p?.description || '';
      qs('#p-order').value = p?.order_num ?? 0;
      qs('#edit-card').style.display = 'block';
    }

    async function save(){
      const payload = {
        title: qs('#p-title').value.trim(),
        linkUrl: qs('#p-link').value.trim(),
        imageUrl: qs('#p-image').value.trim(),
        description: qs('#p-desc').value.trim(),
        order_num: parseInt(qs('#p-order').value || '0', 10)
      };
      const url = editingId ? \`/api/projects/\${editingId}\` : '/api/projects';
      const method = editingId ? 'PUT' : 'POST';
      const r = await fetch(url, {
        method,
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(r.ok){
        qs('#edit-card').style.display = 'none';
        loadList();
      }else{
        alert('Błąd zapisu: ' + r.status);
      }
    }

    async function onTableClick(e){
      const id = e.target.dataset.id;
      if(e.target.classList.contains('editBtn')){
        const r = await fetch('/api/projects/' + id);
        const p = await r.json();
        openEditor(p);
      }
      if(e.target.classList.contains('delBtn')){
        if(confirm('Na pewno usunąć projekt #' + id + '?')){
          const r = await fetch('/api/projects/' + id, {method:'DELETE'});
          if(r.ok){ loadList(); } else { alert('Błąd usuwania'); }
        }
      }
    }

    qs('#loginBtn').addEventListener('click', login);
    qs('#logoutBtn').addEventListener('click', logout);
    qs('#reloadBtn').addEventListener('click', loadList);
    qs('#newBtn').addEventListener('click', ()=>openEditor(null));
    qs('#saveBtn').addEventListener('click', save);
    qs('#cancelBtn').addEventListener('click', ()=>{ qs('#edit-card').style.display='none'; });

    tBody.addEventListener('click', onTableClick);
    checkAuth();
  </script>
</body>
</html>
